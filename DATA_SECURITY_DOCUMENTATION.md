# 智慧党建微信小程序 - 数据安全实施文档

## 项目概述

本项目是一个基于微信小程序的智慧党建管理系统，严格遵循中国数据安全法律法规，实现全方位的数据安全保障体系。

## 法律合规

### 遵循的法律法规

1. **《中华人民共和国网络安全法》**
   - 网络运营者收集、使用个人信息的合法性、正当性、必要性
   - 明示收集、使用信息的目的、方式和范围
   - 用户知情同意机制

2. **《中华人民共和国数据安全法》**
   - 数据分类分级保护制度
   - 数据安全风险评估
   - 数据安全事件应急处置

3. **《中华人民共和国个人信息保护法》**
   - 个人信息处理的合法性基础
   - 敏感个人信息的特殊保护
   - 个人在个人信息处理活动中的权利

## 技术架构

### 核心安全模块

```
miniprogram/
├── config/
│   └── security.config.js          # 安全配置中心
├── utils/security/
│   ├── data-encryption.js          # 数据加密工具
│   ├── audit-logger.js             # 审计日志系统
│   └── security-manager.js         # 安全管理器
├── services/
│   ├── api.service.js              # 安全API服务
│   ├── auth.service.js             # 认证服务
│   ├── opinion.service.js          # 意见稿服务
│   └── member.service.js           # 党员管理服务
└── models/
    ├── user.model.js               # 用户模型
    └── member.model.js             # 党员模型
```

## 数据安全实施细节

### 1. 数据加密 (data-encryption.js)

#### 1.1 加密算法
- 使用XOR加密配合Base64编码
- 动态生成加密密钥
- 密钥安全存储在本地

#### 1.2 敏感数据保护
```javascript
// 敏感字段定义
sensitiveFields: [
  'idCard',      // 身份证号
  'phone',       // 手机号
  'password',    // 密码
  'bankAccount', // 银行账号
  'address',     // 地址
  'email'        // 邮箱
]
```

#### 1.3 数据脱敏
- **身份证号**: 显示前6位和后4位，中间8位用*号替代
- **手机号**: 显示前3位和后4位，中间4位用*号替代
- **邮箱**: 本地部分前2位后用***替代

#### 1.4 输入过滤
- XSS攻击防护
- SQL注入防护
- 脚本标签过滤
- 最大长度限制

### 2. 审计日志 (audit-logger.js)

#### 2.1 日志记录内容
```javascript
{
  id: '日志唯一标识',
  timestamp: '时间戳',
  userId: '用户ID',
  userName: '用户名',
  organizationId: '组织ID',
  role: '用户角色',
  action: '操作类型',
  module: '模块名称',
  level: '日志级别',
  details: {},
  deviceInfo: {},
  success: true/false
}
```

#### 2.2 关键操作审计
- 用户登录/登出
- 数据访问（查询、详情）
- 数据修改（创建、更新、删除）
- 数据导出
- 权限变更
- 安全事件

#### 2.3 日志保留策略
- 本地最多保存1000条日志
- 定期同步到服务器（每5分钟）
- 服务器端保留90天
- 审计日志保留7年（2555天）

### 3. 安全管理器 (security-manager.js)

#### 3.1 权限管理
```javascript
roles: {
  admin: ['*'],  // 全部权限
  park_manager: [
    'view_all_data',
    'manage_organizations',
    'manage_users',
    'publish_news',
    'view_statistics',
    'export_data'
  ],
  enterprise_manager: [
    'view_own_data',
    'submit_opinions',
    'view_announcements',
    'manage_own_members'
  ],
  member: [
    'view_public_data',
    'view_announcements',
    'view_news',
    'submit_opinions'
  ]
}
```

#### 3.2 访问控制
- 基于角色的访问控制（RBAC）
- 权限验证失败自动记录审计日志
- 未授权访问自动拦截

#### 3.3 频率限制
- 每个用户每分钟最多100个请求
- 超出限制自动记录安全事件
- 防止API滥用和DDoS攻击

#### 3.4 输入验证
- 必填字段验证
- 长度限制验证
- 格式验证（手机号、身份证、邮箱）
- 自定义验证规则
- 自动清理危险字符

#### 3.5 会话管理
- Token有效期：2小时
- 自动续期阈值：10分钟
- 失效自动跳转登录
- 防重放攻击

### 4. API安全 (api.service.js)

#### 4.1 请求加密
- 请求数据自动加密
- 添加时间戳防重放
- 添加随机数增强安全性
- 生成请求签名验证完整性

#### 4.2 响应验证
- 状态码验证
- 401未授权自动处理
- 403禁止访问自动记录
- 错误统一处理

#### 4.3 文件传输安全
- 上传文件大小限制（10MB）
- 文件类型验证
- 上传操作审计
- 下载操作审计

### 5. 认证服务 (auth.service.js)

#### 5.1 登录安全
- 密码哈希处理
- 登录失败记录
- Token加密存储
- 微信登录集成

#### 5.2 用户授权
- 明确告知数据用途
- 用户主动同意授权
- 授权记录可追溯
- 支持撤回授权

#### 5.3 密码管理
- 密码复杂度要求
- 密码加密传输
- 密码修改审计

### 6. 数据分类管理

#### 6.1 个人数据
- 姓名、身份证号、联系电话、住址
- 加密存储、脱敏显示
- 保留期限：7年

#### 6.2 敏感数据
- 政治面貌、党员信息、民族、宗教信仰
- 强制加密、严格权限控制
- 保留期限：7年

#### 6.3 组织数据
- 组织架构、人员配置、业务数据
- 访问控制、操作审计
- 保留期限：10年

## 系统功能模块

### 企业用户系统

#### 1. 意见稿模块
- **提交意见**: 主题、内容、附件、联系方式
- **查看意见**: 历史意见、处理状态
- **数据保护**: 输入验证、内容过滤、操作审计

#### 2. 通知公告
- **查看公告**: 名称、时间、内容、附件
- **数据保护**: 访问控制、下载审计

### 园区用户系统

#### 1. 首页概览
- 基本情况统计
- 快捷操作入口
- GIS地图展示

#### 2. 意见稿管理
- 列表查看
- 详情查看
- 状态管理
- 数据导出（需权限）

#### 3. 党建资讯
- 资讯发布
- 轮播设置
- 内容审核

#### 4. 组织机构管理
- 机构维护
- 层级关系
- 权限管理

#### 5. 人员管理
- 党建工作指导员
- 企业网格员
- 导入导出（加密处理）

#### 6. 党员管理
- 信息维护
- 敏感数据保护
- 批量导入导出
- 操作全程审计

#### 7. 统计分析
- 数据可视化
- 权限控制
- 导出审计

## 安全配置说明

### security.config.js 配置项

```javascript
{
  encryption: {
    algorithm: 'AES-256-CBC',    // 加密算法
    keySize: 256,                 // 密钥长度
    iterations: 10000             // 迭代次数
  },
  
  session: {
    timeout: 7200000,             // 会话超时（2小时）
    renewThreshold: 600000,       // 续期阈值（10分钟）
    maxRetries: 3                 // 最大重试次数
  },
  
  apiSecurity: {
    requestTimeout: 30000,        // 请求超时（30秒）
    maxRequestSize: 10485760,     // 最大请求大小（10MB）
    rateLimiting: {
      enabled: true,
      maxRequests: 100,           // 每分钟最大请求数
      windowMs: 60000             // 时间窗口
    }
  },
  
  audit: {
    enabled: true,                // 启用审计
    retention: 90,                // 保留天数
    maxLocalLogs: 1000,           // 本地最大日志数
    syncInterval: 300000          // 同步间隔（5分钟）
  },
  
  compliance: {
    consentRequired: true,        // 需要用户同意
    retentionPeriod: {
      personal: 2555,             // 个人数据保留期（7年）
      audit: 2555,                // 审计日志保留期（7年）
      business: 3650              // 业务数据保留期（10年）
    }
  }
}
```

## 部署与运维

### 1. 环境要求
- 微信开发者工具
- Node.js 14+
- 支持HTTPS的服务器

### 2. 安全检查清单
- [ ] 所有API使用HTTPS
- [ ] Token加密存储
- [ ] 敏感数据加密传输
- [ ] 审计日志正常记录
- [ ] 权限控制正确配置
- [ ] 数据备份策略就绪
- [ ] 应急响应预案完成

### 3. 定期维护
- 每日检查审计日志
- 每周进行安全评估
- 每月更新安全配置
- 每季度进行渗透测试
- 每年进行合规审计

## 应急响应

### 数据泄露响应流程
1. 立即隔离受影响系统
2. 评估泄露范围和影响
3. 通知相关用户
4. 向监管部门报告
5. 修复安全漏洞
6. 审查和更新安全策略

### 安全事件分级
- **严重**: 大规模数据泄露、系统完全瘫痪
- **重要**: 部分数据泄露、权限绕过
- **一般**: 单个账户异常、小范围服务中断
- **提示**: 可疑行为检测、异常访问尝试

## 用户权利保障

### 1. 知情权
- 明确告知数据收集目的
- 说明数据使用范围
- 公开隐私政策

### 2. 同意权
- 首次使用需授权
- 可选择拒绝
- 可随时撤回

### 3. 访问权
- 查看个人数据
- 了解处理情况
- 获取数据副本

### 4. 更正权
- 修改错误数据
- 补充不完整数据

### 5. 删除权
- 请求删除个人数据
- 符合法定条件时执行

### 6. 可携带权
- 获取结构化数据
- 转移至其他服务

## 开发规范

### 1. 代码安全
- 不在代码中硬编码密钥
- 不记录敏感信息到日志
- 使用参数化查询防SQL注入
- 验证所有用户输入

### 2. 数据处理
- 最小化原则：只收集必要数据
- 目的限制：仅用于声明目的
- 存储限制：达到目的后删除
- 安全保护：全程加密保护

### 3. 审计要求
- 所有敏感操作必须审计
- 审计日志不可篡改
- 定期审查审计记录
- 保留足够长的时间

## 测试验证

### 1. 功能测试
- 登录/登出
- 权限控制
- 数据加密/解密
- 审计日志记录

### 2. 安全测试
- SQL注入测试
- XSS攻击测试
- CSRF攻击测试
- 权限绕过测试
- 频率限制测试

### 3. 性能测试
- 并发用户测试
- 数据加密性能
- API响应时间
- 日志同步性能

## 联系与支持

### 技术支持
- 邮箱: support@example.com
- 电话: 400-xxx-xxxx

### 安全事件报告
- 邮箱: security@example.com
- 24小时热线: 400-xxx-xxxx

### 隐私问题咨询
- 邮箱: privacy@example.com
- 工作时间: 周一至周五 9:00-18:00

## 版本历史

### v1.0.0 (2024-01-15)
- 初始版本发布
- 完整的数据安全体系
- 符合中国数据安全法律法规
- 审计日志系统
- 权限管理系统

## 附录

### A. 相关法律法规链接
- [中华人民共和国网络安全法](http://www.npc.gov.cn/)
- [中华人民共和国数据安全法](http://www.npc.gov.cn/)
- [中华人民共和国个人信息保护法](http://www.npc.gov.cn/)

### B. 技术标准参考
- GB/T 35273-2020 信息安全技术 个人信息安全规范
- GB/T 37988-2019 信息安全技术 数据安全能力成熟度模型
- GB/T 22239-2019 信息安全技术 网络安全等级保护基本要求

### C. 术语表
- **RBAC**: 基于角色的访问控制
- **XSS**: 跨站脚本攻击
- **SQL注入**: 结构化查询语言注入攻击
- **CSRF**: 跨站请求伪造
- **Token**: 访问令牌
- **哈希**: 单向加密函数
- **脱敏**: 数据遮蔽处理

---

**文档版本**: 1.0.0  
**最后更新**: 2024-01-15  
**维护团队**: 智慧党建开发组
